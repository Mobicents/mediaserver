#!/usr/bin/env groovy
node("cxs-slave-master") {

    configFileProvider(
        [configFile(fileId: '37cb206e-6498-4d8a-9b3d-379cd0ccd99b',  targetLocation: 'settings.xml')]) {
	    sh 'mkdir -p ~/.m2 && sed -i "s|@LOCAL_REPO_PATH@|$WORKSPACE/M2_REPO|g" $WORKSPACE/settings.xml && cp $WORKSPACE/settings.xml -f ~/.m2/settings.xml'
    }

    stage ('Checkout') {
        checkout scm
    }

    stage ('Versioning') {
        // Drop -SNAPSHOT qualifier
        sh 'mvn versions:set -DremoveSnapshot versions:commit'

        // Save release version
        def pom = readMavenPom file: 'pom.xml'
        env.RELEASE_VERSION = "${pom.version}-${env.BUILD_NUMBER}"
        echo 'Set release version to ${env.RELEASE_VERSION}'

        // Tokenize version
        def versionTokens = ${env.RELEASE_VERSION}.split('.')
        env.MAJOR_VERSION = versionTokens[0]
        env.MINOR_VERSION = versionTokens[1]
        env.PATCH_VERSION = versionTokens[2]
    }

    stage('VerifyBranch') {
        // Verify if branch exists
        env.RELEASE_BRANCH = "stable-$MAJOR_VERSION-$MINOR_VERSION"
        def branchExists = sh(script: 'git ls-remote --heads git@github.com:RestComm/media-core.git ${env.RELEASE_BRANCH} | wc -l', returnStdout: true)

        if(${branchExists} == 1) {
            echo 'Branch $RELEASE_BRANCH already exists. Aborting job.'
            currentBuild.result = 'FAILURE'
            return
        } else {
            echo 'Branch $RELEASE_BRANCH does not exist. Proceeding to next stage.'
        }
    }

    stage ('Build') {
        sh 'mvn clean install -DskipTests'
    }

    stage ('Test') {
        sh 'mvn test'
        junit testResults: '**/target/surefire-reports/*.xml', testDataPublishers: [[$class: 'StabilityTestDataPublisher']]
    }

    stage('Branch') {
        withCredentials([usernamePassword(credentialsId: 'CXSGithub', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh 'git checkout -b ${env.RELEASE_BRANCH}'
            sh 'git commit -a -m "New stable release ${env.RELEASE_VERSION}"'
            sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RestComm/media-core.git origin/${env.RELEASE_BRANCH}'
        }
    }

    stage('Tag') {
        withCredentials([usernamePassword(credentialsId: 'CXSGithub', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh 'git tag ${env.RELEASE_VERSION}'
            sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RestComm/media-core.git --tags'
        }
    }

    stage ('Deploy') {
        sh 'mvn package deploy:deploy -Pattach-sources,generate-javadoc,maven-release -DskipTests -DskipNexusStagingDeployMojo -DaltDeploymentRepository=nexus::default::$CXS_NEXUS2_URL'
    }

    stage ('Release') {
        sh 'mvn clean deploy -DskipTests -Dgpg.passphrase=${env.GPG_PASSPHRASE} -Pattach-sources,generate-javadoc,release-sign-artifacts,cxs-oss-release'
    }

}

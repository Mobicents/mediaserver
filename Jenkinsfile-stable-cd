node("cxs-slave-master") {
    echo sh(returnStdout: true, script: 'env')

    configFileProvider(
        [configFile(fileId: '37cb206e-6498-4d8a-9b3d-379cd0ccd99b',  targetLocation: 'settings.xml')]) {
	    sh 'mkdir -p ~/.m2 && sed -i "s|@LOCAL_REPO_PATH@|$WORKSPACE/M2_REPO|g" $WORKSPACE/settings.xml && cp $WORKSPACE/settings.xml -f ~/.m2/settings.xml'
    }

    stage ('Checkout') {
        checkout scm
    }

    stage ('Versioning') {
        // Drop -SNAPSHOT qualifier
        sh 'mvn versions:set -DremoveSnapshot versions:commit'

        // Save release version
        def pom = readMavenPom file: 'pom.xml'
        env.RELEASE_VERSION = "${pom.version}"
        echo 'Set release version to ${env.RELEASE_VERSION}'
    }

    stage ('Build') {
        sh 'mvn clean install -DskipTests'
    }

    stage ('Test') {
        sh 'mvn test'
        junit testResults: '**/target/surefire-reports/*.xml', testDataPublishers: [[$class: 'StabilityTestDataPublisher']]
    }

    stage('Branch') {
        // Tokenize version
        def (MAJOR_VERSION, MINOR_VERSION, PATCH_VERSION) = ${env.RELEASE_VERSION}.tokenize( '.' )

        withCredentials([usernamePassword(credentialsId: 'CXSGithub', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            env.RELEASE_BRANCH = "stable-$MAJOR_VERSION-$MINOR_VERSION"
            sh 'git checkout -b ${env.RELEASE_BRANCH}'
            sh 'git commit -a -m "New stable release ${env.RELEASE_VERSION}"'
            sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RestComm/media-core.git origin/${env.RELEASE_BRANCH}'
        }
    }

    stage ('Deploy') {
        sh 'mvn package deploy:deploy -Pattach-sources,generate-javadoc,maven-release -DskipTests -DskipNexusStagingDeployMojo -DaltDeploymentRepository=nexus::default::$CXS_NEXUS2_URL'
    }

    stage('Tag') {
        withCredentials([usernamePassword(credentialsId: 'CXSGithub', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh 'git tag ${env.RELEASE_VERSION}''
            sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RestComm/media-core.git --tags'
        }
    }

}
